---
name: CI

# yamllint disable-line rule:truthy
on:
  push:
    branches:
      - main
  pull_request: {}

permissions:
  attestations: write
  contents: read
  id-token: write

jobs:
  prepare:
    runs-on: ubuntu-24.04-arm
    outputs:
      release-name: ${{ steps.release-name.outputs.RELEASE_NAME }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      - name: Generate Release Name
        id: release-name
        run: |
          echo "RELEASE_NAME=$(make name)" >> "$GITHUB_OUTPUT"
      # removed tag generation (not needed for quick CI tests)

  core-matrix:
    runs-on: ubuntu-24.04-arm
    env:
      PLATFORM: ${{ matrix.toolchain }}
    outputs:
      cores: ${{ steps.cores.outputs.cores }}
    strategy:
      fail-fast: true
      matrix:
        toolchain:
          - tg5040

    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Generate cores matrix
        id: cores
        run: |
          CORES="$(make cores-json)"
          echo "cores=$CORES" >> $GITHUB_OUTPUT

  build-core:
    needs: core-matrix
    runs-on: ubuntu-24.04-arm
    env:
      PLATFORM: ${{ matrix.toolchain }}
    strategy:
      fail-fast: false
      max-parallel: 8
      matrix:
        toolchain:
          - tg5040
        core: ${{ fromJson(needs.core-matrix.outputs.cores) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Get toolchain hash
        id: toolchain-hash
        run: |
          if [[ -d "toolchains/${PLATFORM}-toolchain/.git" ]]; then
            TOOLCHAIN_HASH=$(cd "toolchains/${PLATFORM}-toolchain" && git rev-parse HEAD)
          else
            TOOLCHAIN_HASH="missing"
          fi
          echo "toolchain-hash=${TOOLCHAIN_HASH}" >> "$GITHUB_OUTPUT"
          echo "Toolchain hash: ${TOOLCHAIN_HASH}"

      - name: Get core source hash
        id: core-hash
        run: |
          if [[ -d "workspace/${PLATFORM}/cores/src/${{ matrix.core }}" ]]; then
            CORE_HASH=$(cd "workspace/${PLATFORM}/cores/src/${{ matrix.core }}" && git rev-parse HEAD 2>/dev/null || echo "unknown")
          else
            CORE_HASH="unknown"
          fi
          echo "core-hash=${CORE_HASH}" >> "$GITHUB_OUTPUT"
          echo "Core ${{ matrix.core }} hash: ${CORE_HASH}"

      - name: Cache toolchains
        uses: actions/cache@v4
        with:
          path: toolchains
          key: toolchains-${{ runner.os }}-${{ env.PLATFORM }}-modernize-${{ steps.toolchain-hash.outputs.toolchain-hash }}

      - name: Cache compiled cores
        uses: actions/cache@v4
        with:
          path: workspace/${{ env.PLATFORM }}/cores/output/${{ matrix.core }}_libretro.so
          key: core-${{ env.PLATFORM }}-${{ matrix.core }}-${{ steps.core-hash.outputs.core-hash }}-${{ steps.toolchain-hash.outputs.toolchain-hash }}

      - name: Restore toolchain from cache
        run: |
          if [[ ! -d "toolchains/${PLATFORM}-toolchain/.git" ]]; then
            echo "Toolchain not in cache, will need to download"
          else
            echo "Toolchain restored from cache"
          fi

      - name: Ensure toolchain repo (retry)
        shell: bash
        run: |
          set -uo pipefail
          if [[ -d "toolchains/${PLATFORM}-toolchain/.git" ]]; then
            echo "Toolchain repo already present (from cache)."
            exit 0
          fi
          mkdir -p toolchains
          git config --global http.postBuffer 524288000
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999
          for i in 1 2 3 4 5 6 7 8 9 10; do
            echo "Cloning toolchain (attempt $i of 10)..."
            if timeout 300 git clone -b modernize --depth 1 "https://github.com/LoveRetro/${PLATFORM}-toolchain/" "toolchains/${PLATFORM}-toolchain" 2>&1; then
              echo "Toolchain cloned successfully on attempt $i"
              exit 0
            else
              CLONE_EXIT=$?
              echo "::warning::Clone attempt $i failed with exit code $CLONE_EXIT"
              rm -rf "toolchains/${PLATFORM}-toolchain" || true
              if [[ $i -lt 10 ]]; then
                echo "Waiting $((i * 15)) seconds before retry..."
                sleep $((i * 15))
              fi
            fi
          done
          echo "::error::Failed to clone toolchain repo after 10 attempts"
          exit 1

      - name: Setup
        run: make setup

      - name: Check if core is cached
        id: core-cached
        run: |
          if [[ -f "workspace/${PLATFORM}/cores/output/${{ matrix.core }}_libretro.so" ]]; then
            echo "core-exists=true" >> "$GITHUB_OUTPUT"
            echo "Core ${{ matrix.core }} already compiled, skipping build"
          else
            echo "core-exists=false" >> "$GITHUB_OUTPUT"
            echo "Core ${{ matrix.core }} not cached, will build"
          fi

      - name: Build ${{ matrix.core }} core
        if: steps.core-cached.outputs.core-exists != 'true'
        run: make build-core CORE=${{ matrix.core }}

      - name: Upload core
        uses: actions/upload-artifact@v4.6.2
        with:
          name: core-${{ matrix.toolchain }}-${{ matrix.core }}.zip
          path: workspace/${{ env.PLATFORM }}/cores/output/

  build:
    needs:
      - prepare
      - build-core
    runs-on: ubuntu-24.04-arm
    env:
      PLATFORM: ${{ matrix.toolchain }}
      RELEASE_NAME: ${{ needs.prepare.outputs.release-name }}
      # Use the workflow run id as a stable, non-tag-based identifier for quick testing
      RELEASE_VERSION: ${{ github.run_id }}
    strategy:
      fail-fast: true
      matrix:
        toolchain:
          - tg5040

    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Inject fonts (CI-time)
        shell: bash
        env:
          DREAM_VERSION: dream-3.01-sans-2.004-serif-2.002
          FUSION_VERSION: 2026.01.04
        run: |
          set -euo pipefail
          install -d skeleton/SYSTEM/res
          
          # Download Dream Han Sans CN
          mkdir -p /tmp/dream-han-sans
          DREAM_ZIP_OUT="/tmp/dream-han-sans/DreamHanSansCN.zip"
          DREAM_URL="https://github.com/Pal3love/dream-han-cjk/releases/download/${DREAM_VERSION}/DreamHanSansCN.zip"
          echo "Downloading Dream Han Sans CN: $DREAM_URL"
          curl -fL --retry 5 --retry-delay 2 --connect-timeout 20 -o "$DREAM_ZIP_OUT" "$DREAM_URL"
          unzip -q "$DREAM_ZIP_OUT" -d /tmp/dream-han-sans
          DREAM_SRC_DIR="/tmp/dream-han-sans"
          DREAM_FONT_W16="$(find "$DREAM_SRC_DIR" -maxdepth 3 -type f -name 'DreamHanSansCN-W16.ttf' | head -n 1 || true)"
          if [[ -z "$DREAM_FONT_W16" ]]; then
            echo "Extracted Dream Han Sans files:"; find "$DREAM_SRC_DIR" -maxdepth 3 -type f | sed 's#^#- #' || true
            echo "::error::Dream Han Sans CN W16 TTF font not found in release archive"
            exit 1
          fi
          cp -f "$DREAM_FONT_W16" skeleton/SYSTEM/res/font1.ttf
          echo "Injected Dream Han Sans CN W16 as font1.ttf"
          
          # Download Fusion Pixel
          mkdir -p /tmp/fusion-pixel-font
          FUSION_ZIP_OUT="/tmp/fusion-pixel-font/fusion-pixel-font-12px-proportional-ttf-v${FUSION_VERSION}.zip"
          FUSION_URL="https://github.com/TakWolf/fusion-pixel-font/releases/download/v${FUSION_VERSION}/fusion-pixel-font-12px-proportional-ttf-v${FUSION_VERSION}.zip"
          echo "Downloading Fusion Pixel: $FUSION_URL"
          curl -fL --retry 5 --retry-delay 2 --connect-timeout 20 -o "$FUSION_ZIP_OUT" "$FUSION_URL"
          unzip -q "$FUSION_ZIP_OUT" -d /tmp/fusion-pixel-font
          FUSION_SRC_DIR="/tmp/fusion-pixel-font"
          FUSION_FONT="$(find "$FUSION_SRC_DIR" -maxdepth 1 -type f -name 'fusion-pixel-12px-proportional-zh_hans.ttf' | head -n 1 || true)"
          if [[ -z "$FUSION_FONT" ]]; then
            echo "Extracted Fusion Pixel files:"; find "$FUSION_SRC_DIR" -maxdepth 1 -type f | sed 's#^#- #' || true
            echo "::error::Fusion Pixel TTF font not found in release archive"
            exit 1
          fi
          cp -f "$FUSION_FONT" skeleton/SYSTEM/res/font2.ttf
          echo "Injected Fusion Pixel as font2.ttf"
          
          # Also copy to BPreplay fonts
          cp -f "$FUSION_FONT" skeleton/SYSTEM/res/BPreplayBold-unhinted.ttf
          cp -f "$FUSION_FONT" skeleton/SYSTEM/res/BPreplayBold.ttf
          
          echo "All fonts injected into skeleton/SYSTEM/res:"
          ls -la skeleton/SYSTEM/res | sed 's#^#- #' || true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zipmerge p7zip-full

      - name: Setup
        run: make setup

      - name: Download Cores
        uses: actions/download-artifact@v4.3.0
        with:
          path: workspace/${{ env.PLATFORM }}/cores/output/
          pattern: core-${{ matrix.toolchain }}-*
          merge-multiple: true

      - name: Build
        run: make ${{ matrix.toolchain }}

      - name: Special
        run: make special

      - name: Package
        run: make package

      - name: Upload All
        uses: actions/upload-artifact@v4.6.2
        with:
          # Use ASCII-only artifact names (avoid branch names with non-ASCII)
          name: nextui-${{ github.run_id }}-all.zip
          path: releases/${{ env.RELEASE_NAME }}-all.zip

      - name: Upload Base
        uses: actions/upload-artifact@v4.6.2
        with:
          name: nextui-${{ github.run_id }}-base.zip
          path: releases/${{ env.RELEASE_NAME }}-base.zip

      - name: Upload Extras
        uses: actions/upload-artifact@v4.6.2
        with:
          name: nextui-${{ github.run_id }}-extras.zip
          path: releases/${{ env.RELEASE_NAME }}-extras.zip

      - name: Generate prerelease notes
        run: |
          echo "NextUI quick prerelease build notes" > notes_zh.txt
          echo "Built by CI on branch: $GITHUB_REF" >> notes_zh.txt
          echo "Recent commits:" >> notes_zh.txt
          git --no-pager log -n 20 --pretty=format:"- %s by @%an in %h" >> notes_zh.txt || true

      - name: Upload prerelease notes
        uses: actions/upload-artifact@v4.6.2
        with:
          name: nextui-prerelease-${{ github.run_id }}-notes
          path: notes_zh.txt

      - name: Skip Attest for PRs from forks
        id: skip
        if: github.ref != 'refs/heads/main'
        run: |
          echo '::warning title=Attest skipped::Attest action requires permissions and is performed only for main branch.'

      - name: Attest Build Provenance
        uses: actions/attest-build-provenance@v2.3.0
        if: github.ref == 'refs/heads/main'
        with:
          subject-path: |
            releases/${{ env.RELEASE_NAME }}-all.zip
            releases/${{ env.RELEASE_NAME }}-base.zip
            releases/${{ env.RELEASE_NAME }}-extras.zip
