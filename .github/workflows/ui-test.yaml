name: UI Tests with Simulator

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'bugfix/**'
      - 'refactor/**'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

jobs:
  ui-simulator-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      - name: Install SDL2 dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libsdl2-dev \
            libsdl2-image-dev \
            libsdl2-ttf-dev \
            libpng-dev \
            libjpeg-dev \
            zlib1g-dev

      - name: Build UI simulator
        run: |
          cd workspace/all/nextui
          make -f makefile.test clean
          make -f makefile.test all

      - name: Run auto-traversal screenshot tests
        run: |
          cd workspace/all/nextui
          ./build/desktop/nextui_simulator --auto --delay 100

      - name: Create baseline (main branch only)
        if: github.ref == 'refs/heads/main'
        run: |
          cd workspace/all/nextui
          mkdir -p baseline
          cp screenshots/*.bmp baseline/
          echo "Baseline images created at $(date)"

      - name: Compare screenshots with baseline
        if: github.ref != 'refs/heads/main'
        run: |
          cd workspace/all/nextui
          
          if [ -d "baseline" ]; then
            echo "Comparing screenshots with baseline..."
            
            # Count total screenshots
            TOTAL=$(ls screenshots/*.bmp 2>/dev/null | wc -l)
            MATCHED=0
            DIFFERENT=0
            
            echo "# Screenshot Comparison Report" > comparison_report.md
            echo "" >> comparison_report.md
            echo "## Build Information" >> comparison_report.md
            echo "- Branch: \`${GITHUB_REF}\`" >> comparison_report.md
            echo "- Commit: \`${GITHUB_SHA}\`" >> comparison_report.md
            echo "- Run ID: \`${GITHUB_RUN_ID}\`" >> comparison_report.md
            echo "- Run Number: \`${GITHUB_RUN_NUMBER}\`" >> comparison_report.md
            echo "" >> comparison_report.md
            echo "## Comparison Results" >> comparison_report.md
            echo "" >> comparison_report.md
            echo "| File | Status | Diff Size |" >> comparison_report.md
            echo "|------|--------|-----------|" >> comparison_report.md
            
            # Compare each screenshot with baseline
            for file in screenshots/*.bmp; do
              filename=$(basename "$file")
              baseline="baseline/$filename"
              
              if [ -f "$baseline" ]; then
                # Calculate difference
                diff_size=$(diff "$file" "$baseline" | wc -c)
                
                if [ "$diff_size" -eq 0 ]; then
                  MATCHED=$((MATCHED + 1))
                  echo "| $filename | ‚úÖ Match | 0 bytes |" >> comparison_report.md
                else
                  DIFFERENT=$((DIFFERENT + 1))
                  echo "| $filename | ‚ùå Different | $diff_size bytes |" >> comparison_report.md
                  
                  # Create visual diff
                  diff -u "$baseline" "$file" > "${file%.bmp}_diff.txt" 2>/dev/null || true
                fi
              else
                echo "| $filename | ‚ö†Ô∏è No baseline | - |" >> comparison_report.md
              fi
            done
            
            echo "" >> comparison_report.md
            echo "## Summary" >> comparison_report.md
            echo "- Total screenshots: $TOTAL" >> comparison_report.md
            echo "- Matched: $MATCHED" >> comparison_report.md
            echo "- Different: $DIFFERENT" >> comparison_report.md
            echo "- No baseline: $((TOTAL - MATCHED - DIFFERENT))" >> comparison_report.md
            
            echo "" >> comparison_report.md
            echo "## Success Rate" >> comparison_report.md
            if [ "$TOTAL" -gt 0 ]; then
              RATE=$((MATCHED * 100 / TOTAL))
              echo "- $RATE% ($MATCHED/$TOTAL)" >> comparison_report.md
            fi
            
            # Exit with error if any differences found
            if [ "$DIFFERENT" -gt 0 ]; then
              echo "::warning::$DIFFERENT screenshots differ from baseline"
              exit 1
            else
              echo "All screenshots match baseline!"
            fi
          else
            echo "No baseline found - creating comparison report without comparison"
            echo "# Screenshot Comparison Report" > comparison_report.md
            echo "" >> comparison_report.md
            echo "## Build Information" >> comparison_report.md
            echo "- Branch: \`${GITHUB_REF}\`" >> comparison_report.md
            echo "- Commit: \`${GITHUB_SHA}\`" >> comparison_report.md
            echo "- Run ID: \`${GITHUB_RUN_ID}\`" >> comparison_report.md
            echo "- Run Number: \`${GITHUB_RUN_NUMBER}\`" >> comparison_report.md
            echo "" >> comparison_report.md
            echo "## Screenshots Captured" >> comparison_report.md
            echo "" >> comparison_report.md
            ls screenshots/*.bmp | while read file; do
              echo "- $(basename "$file")" >> comparison_report.md
            done
          fi

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4.6.2
        with:
          name: ui-screenshots-${{ github.run_id }}
          path: workspace/all/nextui/screenshots/
          retention-days: 30

      - name: Upload baseline (main branch)
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4.6.2
        with:
          name: ui-baseline-${{ github.run_id }}
          path: workspace/all/nextui/baseline/
          retention-days: 90

      - name: Upload comparison report
        if: always()
        uses: actions/upload-artifact@v4.6.2
        with:
          name: ui-comparison-report-${{ github.run_id }}
          path: workspace/all/nextui/comparison_report.md
          retention-days: 30

      - name: Comment test results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Read comparison report
            const reportPath = 'workspace/all/nextui/comparison_report.md';
            let report = 'Comparison report not available';
            
            if (fs.existsSync(reportPath)) {
              report = fs.readFileSync(reportPath, 'utf8');
            }
            
            // Check for differences
            const diffDir = 'workspace/all/nextui/screenshots';
            let hasDifferences = false;
            let diffCount = 0;
            
            if (fs.existsSync(diffDir) && fs.existsSync('workspace/all/nextui/baseline')) {
              const files = fs.readdirSync(diffDir);
              const baselineFiles = fs.readdirSync('workspace/all/nextui/baseline');
              
              files.forEach(file => {
                if (baselineFiles.includes(file)) {
                  const diff = require('child_process').execSync(
                    `diff workspace/all/nextui/baseline/${file} workspace/all/nextui/screenshots/${file}`,
                    { encoding: 'utf8' }
                  );
                  if (diff.trim()) {
                    diffCount++;
                  }
                }
              });
              
              hasDifferences = diffCount > 0;
            }
            
            // Create comment
            let comment = '## üé® UI Screenshot Test Results\n\n';
            
            if (hasDifferences) {
              comment += '‚ùå **Some screenshots differ from baseline**\n\n';
              comment += `${diffCount} screenshots have visual differences.\n\n`;
              comment += 'Please review the screenshots in the artifacts.\n';
            } else {
              comment += '‚úÖ **All screenshots match baseline**\n\n';
            }
            
            comment += '\n' + report;
            
            // Post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });