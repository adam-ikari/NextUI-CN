---
name: Release NextUI

# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "release type"
        default: "patch"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      tag:
        description: "Optional manual tag (vX.Y.Z-CN[-suffix] or vX.Y.Z; empty = auto bump)"
        required: false
        type: string

permissions:
  attestations: write
  contents: write
  id-token: write

jobs:
  prepare:
    runs-on: ubuntu-24.04
    outputs:
      next-tag: ${{ steps.resolve-tag.outputs.version }}
      release-name: ${{ steps.release-name.outputs.RELEASE_NAME }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      - name: Generate Release Name
        id: release-name
        run: |
          echo "RELEASE_NAME=$(make name)" >> "$GITHUB_OUTPUT"

      - name: Get Latest Tag
        id: latest-tag
        if: ${{ github.event.inputs.tag == '' }}
        run: |
          # NextUI-CN uses vX.Y.Z-CN tags; upstream tags don't include -CN.
          CN_TAG="$(git tag --list 'v*.*.*-CN' --sort=-v:refname | head -n 1 || true)"
          if [ -z "$CN_TAG" ]; then
            # Fallback for first CN release on a repo that only has upstream-style tags.
            CN_TAG="$(git tag --list 'v*.*.*' --sort=-v:refname | head -n 1 || true)"
          fi
          BASE_TAG="$(echo "$CN_TAG" | sed 's/-CN$//')"
          echo GIT_LATEST_TAG="$BASE_TAG" >>"$GITHUB_OUTPUT"

      - name: Compute Next Tag
        id: next-tag
        uses: docker://ghcr.io/dokku/semver-generator:latest
        if: ${{ github.event.inputs.tag == '' }}
        with:
          bump: ${{ github.event.inputs.release_type }}
          input: ${{ steps.latest-tag.outputs.GIT_LATEST_TAG }}

      - name: Append -CN suffix
        id: next-tag-cn
        if: ${{ github.event.inputs.tag == '' }}
        run: |
          echo "version=${{ steps.next-tag.outputs.version }}-CN" >> "$GITHUB_OUTPUT"

      - name: Resolve Release Tag
        id: resolve-tag
        shell: bash
        env:
          MANUAL_TAG: ${{ github.event.inputs.tag }}
          AUTO_TAG: ${{ steps.next-tag-cn.outputs.version }}
        run: |
          set -euo pipefail

          TAG="$MANUAL_TAG"
          if [[ -z "$TAG" ]]; then
            TAG="$AUTO_TAG"
          fi

          # Allow vX.Y.Z as shorthand (auto append -CN)
          if [[ "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            TAG="${TAG}-CN"
          fi

          # Allow optional suffix after -CN, e.g. v6.6.0-CN-fix1
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-CN([-.][0-9A-Za-z][0-9A-Za-z.-]*)?$ ]]; then
            echo "::error::Invalid tag '$TAG'. Use vX.Y.Z-CN[-suffix] (or vX.Y.Z to auto-append -CN)."
            exit 1
          fi

          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "::error::Tag already exists: $TAG"
            exit 1
          fi

          echo "version=$TAG" >> "$GITHUB_OUTPUT"

  core-matrix:
    runs-on: ubuntu-24.04-arm
    env:
      PLATFORM: ${{ matrix.toolchain }}
    outputs:
      cores: ${{ steps.cores.outputs.cores }}
    strategy:
      fail-fast: true
      matrix:
        toolchain:
          - tg5040

    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Generate cores matrix
        id: cores
        run: |
          CORES="$(make cores-json)"
          echo "cores=$CORES" >> $GITHUB_OUTPUT

  build-core:
    needs: core-matrix
    runs-on: ubuntu-24.04-arm
    env:
      PLATFORM: ${{ matrix.toolchain }}
    strategy:
      fail-fast: true
      matrix:
        toolchain:
          - tg5040
        core: ${{ fromJson(needs.core-matrix.outputs.cores) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Cache toolchains
        uses: actions/cache@v4
        with:
          path: toolchains
          key: toolchains-${{ runner.os }}-${{ env.PLATFORM }}-modernize

      - name: Ensure toolchain repo (retry)
        shell: bash
        run: |
          set -euo pipefail
          if [[ -d "toolchains/${PLATFORM}-toolchain/.git" ]]; then
            echo "Toolchain repo already present (from cache)."
            exit 0
          fi
          mkdir -p toolchains
          for i in 1 2 3 4 5; do
            echo "Cloning toolchain (attempt $i)..."
            if git clone -b modernize --depth 1 "https://github.com/LoveRetro/${PLATFORM}-toolchain/" "toolchains/${PLATFORM}-toolchain"; then
              exit 0
            fi
            rm -rf "toolchains/${PLATFORM}-toolchain" || true
            sleep $((i * 10))
          done
          echo "::error::Failed to clone toolchain repo after retries"
          exit 1

      - name: Setup
        run: make setup

      - name: Build ${{ matrix.core }} core
        run: make build-core CORE=${{ matrix.core }}

      - name: Upload core
        uses: actions/upload-artifact@v4.6.2
        with:
          name: core-${{ matrix.toolchain }}-${{ matrix.core }}.zip
          path: workspace/${{ env.PLATFORM }}/cores/output/

  build:
    needs:
      - build-core
      - prepare
    runs-on: ubuntu-24.04-arm
    env:
      PLATFORM: ${{ matrix.toolchain }}
      RELEASE_NAME: ${{ needs.prepare.outputs.release-name }}
      RELEASE_VERSION: ${{ needs.prepare.outputs.next-tag }}
    strategy:
      fail-fast: true
      matrix:
        toolchain:
          - tg5040

    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2

      - name: Inject fonts (CI-time)
        shell: bash
        env:
          DREAM_VERSION: dream-3.02-sans-2.004-serif-2.003
          FUSION_VERSION: 2026.01.04
          CHILLROUND_VERSION: v1.800
        run: |
          set -euo pipefail
          install -d skeleton/SYSTEM/res
          
          # Download Dream Han Sans CN
          mkdir -p /tmp/dream-han-sans
          DREAM_ZIP_OUT="/tmp/dream-han-sans/DreamHanSansCN.zip"
          DREAM_URL="https://github.com/Pal3love/dream-han-cjk/releases/download/${DREAM_VERSION}/DreamHanSansCN.zip"
          echo "Downloading Dream Han Sans CN: $DREAM_URL"
          curl -fL --retry 5 --retry-delay 2 --connect-timeout 20 -o "$DREAM_ZIP_OUT" "$DREAM_URL"
          unzip -q "$DREAM_ZIP_OUT" -d /tmp/dream-han-sans
          DREAM_SRC_DIR="/tmp/dream-han-sans"
          DREAM_FONT_W16="$(find "$DREAM_SRC_DIR" -maxdepth 3 -type f -name 'DreamHanSansCN-W10.ttf' | head -n 1 || true)"
          if [[ -z "$DREAM_FONT_W16" ]]; then
            echo "Extracted Dream Han Sans files:"; find "$DREAM_SRC_DIR" -maxdepth 3 -type f | sed 's#^#- #' || true
            echo "::error::Dream Han Sans CN W10 TTF font not found in release archive"
            exit 1
          fi
          cp -f "$DREAM_FONT_W16" skeleton/SYSTEM/res/font1.ttf
          echo "Injected Dream Han Sans CN W10 as font1.ttf"
          
          # Download Fusion Pixel
          mkdir -p /tmp/fusion-pixel-font
          FUSION_ZIP_OUT="/tmp/fusion-pixel-font/fusion-pixel-font-12px-proportional-ttf-v${FUSION_VERSION}.zip"
          FUSION_URL="https://github.com/TakWolf/fusion-pixel-font/releases/download/${FUSION_VERSION}/fusion-pixel-font-12px-proportional-ttf-v${FUSION_VERSION}.zip"
          echo "Downloading Fusion Pixel: $FUSION_URL"
          curl -fL --retry 5 --retry-delay 2 --connect-timeout 20 -o "$FUSION_ZIP_OUT" "$FUSION_URL"
          unzip -q "$FUSION_ZIP_OUT" -d /tmp/fusion-pixel-font
          FUSION_SRC_DIR="/tmp/fusion-pixel-font"
          FUSION_FONT="$(find "$FUSION_SRC_DIR" -maxdepth 1 -type f -name 'fusion-pixel-12px-proportional-zh_hans.ttf' | head -n 1 || true)"
          if [[ -z "$FUSION_FONT" ]]; then
            echo "Extracted Fusion Pixel files:"; find "$FUSION_SRC_DIR" -maxdepth 1 -type f | sed 's#^#- #' || true
            echo "::error::Fusion Pixel TTF font not found in release archive"
            exit 1
          fi
          cp -f "$FUSION_FONT" skeleton/SYSTEM/res/font2.ttf
          echo "Injected Fusion Pixel as font2.ttf"
          
          # Download ChillRound (寒蝉半圆体)
          mkdir -p /tmp/chillround-font
          CHILLROUND_ZIP_OUT="/tmp/chillround-font/ChillRoundM_v1.800.zip"
          CHILLROUND_URL="https://github.com/Warren2060/ChillRound/releases/download/${CHILLROUND_VERSION}/ChillRoundM_v1.800.zip"
          echo "Downloading ChillRound: $CHILLROUND_URL"
          curl -fL --retry 5 --retry-delay 2 --connect-timeout 20 -o "$CHILLROUND_ZIP_OUT" "$CHILLROUND_URL"
          unzip -q "$CHILLROUND_ZIP_OUT" -d /tmp/chillround-font
          CHILLROUND_SRC_DIR="/tmp/chillround-font"
          CHILLROUND_FONT="$(find "$CHILLROUND_SRC_DIR" -maxdepth 3 -type f -iname 'ChillRoundM.ttf' | head -n 1 || true)"
          if [[ -z "$CHILLROUND_FONT" ]]; then
            # Try OTF as fallback
            CHILLROUND_FONT="$(find "$CHILLROUND_SRC_DIR" -maxdepth 3 -type f -iname 'ChillRoundM.otf' | head -n 1 || true)"
          fi
          if [[ -z "$CHILLROUND_FONT" ]]; then
            echo "Extracted ChillRound files:"; find "$CHILLROUND_SRC_DIR" -maxdepth 3 -type f | sed 's#^#- #' || true
            echo "::error::ChillRound font not found in release archive"
            exit 1
          fi
          cp -f "$CHILLROUND_FONT" skeleton/SYSTEM/res/font3.ttf
          echo "Injected ChillRound as font3.ttf"
          
          # Also copy to BPreplay fonts
          cp -f "$FUSION_FONT" skeleton/SYSTEM/res/BPreplayBold-unhinted.ttf
          cp -f "$FUSION_FONT" skeleton/SYSTEM/res/BPreplayBold.ttf
          
          echo "All fonts injected into skeleton/SYSTEM/res:";
          ls -la skeleton/SYSTEM/res | sed 's#^#- #' || true

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zipmerge p7zip-full

      - name: Setup
        run: make setup

      - name: Download Cores
        uses: actions/download-artifact@v4.3.0
        with:
          path: workspace/${{ env.PLATFORM }}/cores/output/
          pattern: core-${{ matrix.toolchain }}-*
          merge-multiple: true

      - name: Build
        run: make ${{ matrix.toolchain }}

      - name: Special
        run: make special

      # note: when multiple platforms are built
      # the package step will need to be revamped to
      # merge the release files from each platform into
      # a single release
      - name: Package
        run: make package

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: release-${{ matrix.toolchain }}.zip
          path: releases/

      - name: Attest Build Provenance
        uses: actions/attest-build-provenance@v2.3.0
        with:
          subject-path: |
            releases/${{ env.RELEASE_NAME }}-all.zip
            releases/${{ env.RELEASE_NAME }}-base.zip
            releases/${{ env.RELEASE_NAME }}-extras.zip

  release:
    needs:
      - build
      - prepare
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      - name: Download Release Artifacts
        uses: actions/download-artifact@v4.3.0
        with:
          path: releases/
          pattern: release-*
          merge-multiple: true

      - name: Create and Push Tag
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git tag "$GIT_NEXT_TAG"
          git push origin "$GIT_NEXT_TAG"
        env:
          GIT_NEXT_TAG: ${{ needs.prepare.outputs.next-tag }}

      - name: Generate Release Notes (ZH + changelog)
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force

          CURR_TAG="${{ needs.prepare.outputs.next-tag }}"
          REPO="${{ github.repository }}"

          # Find previous semver tag, excluding the tag we just created.
          PREV_TAG="$(git tag --list 'v*.*.*-CN' --sort=-v:refname | grep -v "^${CURR_TAG}$" | head -n 1 || true)"
          if [[ -n "$PREV_TAG" ]] && git rev-parse "$PREV_TAG" >/dev/null 2>&1; then
            git log --pretty=format:"- %s by @%an in %h" "$PREV_TAG..HEAD" > changes.txt
            CHANGELOG_URL="https://github.com/${REPO}/compare/${PREV_TAG}...${CURR_TAG}"
          else
            git log --pretty=format:"- %s by @%an in %h" HEAD > changes.txt
            CHANGELOG_URL=""
          fi

          {
            echo "NextUI 的完整功能列表和使用帮助："
            echo "https://nextui.loveretro.games/docs/"
            echo
            echo "## 如何安装/更新"
            echo "全新安装请参考：https://nextui.loveretro.games/getting-started/installation/"
            echo "从旧版本升级请参考：https://nextui.loveretro.games/getting-started/updating/"
            echo
            echo "## 主要变更 (What's Changed)"
            cat changes.txt
            if [[ -n "$CHANGELOG_URL" ]]; then
              echo
              echo "**完整变更日志 (Full Changelog)**: ${CHANGELOG_URL}"
            fi
          } > notes_zh.txt

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: releases/*
          tag_name: ${{ needs.prepare.outputs.next-tag }}
          make_latest: "true"
          body_path: notes_zh.txt

