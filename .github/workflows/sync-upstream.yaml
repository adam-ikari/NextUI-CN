name: Sync Upstream

on:
  # schedule:
  #   # UTC 0ç‚¹èµ·æ¯éš”30åˆ†é’ŸåŒæ­¥ä¸€æ¬¡
  #   - cron: '0,30 * * * *'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: sync-upstream-main
  cancel-in-progress: false

jobs:
  sync-commits:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (main)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream and fetch
        run: |
          git remote add upstream https://github.com/LoveRetro/NextUI.git
          git fetch upstream main

      - name: Check for new upstream commits
        id: check_commits
        run: |
          NEW_COMMITS=$(git rev-list HEAD..upstream/main --count)
          echo "new_commits=$NEW_COMMITS" >> $GITHUB_OUTPUT
          echo "å‘ç° $NEW_COMMITS ä¸ªæ–°æäº¤"

          if [ "$NEW_COMMITS" -gt 0 ]; then
            echo "has_new_commits=true" >> $GITHUB_OUTPUT
            echo "upstreamæœ‰æ–°æäº¤ï¼Œå‡†å¤‡åŒæ­¥"
          else
            echo "has_new_commits=false" >> $GITHUB_OUTPUT
            echo "upstreamæ— æ–°æäº¤"
          fi

      - name: Sync upstream commits
        if: steps.check_commits.outputs.has_new_commits == 'true'
        run: |
          echo "æ­£åœ¨åŒæ­¥upstreamæäº¤..."
          if git merge upstream/main --no-edit; then
            echo "åŒæ­¥æˆåŠŸï¼Œæ¨é€åˆ°è¿œç¨‹ä»“åº“"
            git push origin main
          else
            echo "::error::åŒæ­¥å¤±è´¥ï¼šå‘ç°åˆå¹¶å†²çª"
            echo "éœ€è¦æ‰‹åŠ¨è§£å†³å†²çª"
            git merge --abort
            exit 1
          fi

      - name: Send email notification on conflict
        if: failure() && steps.check_commits.outputs.has_new_commits == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.EMAIL_SERVER }}
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "ğŸš¨ NextUI-CN UpstreamåŒæ­¥å†²çªéœ€è¦æ‰‹åŠ¨è§£å†³"
          to: ${{ secrets.EMAIL_TO }}
          from: "GitHub Actions <${{ secrets.EMAIL_USERNAME }}>"
          body: |
            upstreamä»“åº“ LoveRetro/NextUI æœ‰æ–°æäº¤ï¼Œä½†è‡ªåŠ¨åŒæ­¥æ—¶å‘ç”Ÿå†²çªã€‚

            éœ€è¦æ‰‹åŠ¨è§£å†³å†²çªï¼š
            1. git fetch upstream main
            2. git checkout main
            3. git merge upstream/main
            4. è§£å†³å†²çªæ–‡ä»¶
            5. git add .
            6. git commit
            7. git push origin main

            è‡ªåŠ¨åŒæ­¥å¤±è´¥æ—¶é—´ï¼š$(date)

            è¯·å°½å¿«å¤„ç†ä»¥ç¡®ä¿ä»£ç åŒæ­¥ã€‚

  check-release:
    runs-on: ubuntu-latest
    needs: sync-commits
    if: always()
    steps:
      - name: Checkout repository (main)
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get upstream latest release
        id: upstream_release
        shell: bash
        run: |
          set -euo pipefail
          RELEASE_DATA=$(curl -s https://api.github.com/repos/LoveRetro/NextUI/releases/latest)
          UPSTREAM_TAG=$(echo "$RELEASE_DATA" | jq -r '.tag_name // empty')

          if [ -n "$UPSTREAM_TAG" ] && [ "$UPSTREAM_TAG" != "null" ]; then
            echo "upstream_tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT
            echo "å‘ç°upstreamæœ€æ–°release: $UPSTREAM_TAG"
          else
            echo "upstream_tag=" >> $GITHUB_OUTPUT
            echo "upstreamæš‚æ— release"
          fi

      - name: Get local latest release
        id: local_release
        shell: bash
        run: |
          set -euo pipefail
          LOCAL_TAG=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r '.tag_name // empty')

          if [ -n "$LOCAL_TAG" ] && [ "$LOCAL_TAG" != "null" ]; then
            BASE_VERSION=$(echo "$LOCAL_TAG" | sed 's/-CN$//')
            echo "local_tag=$LOCAL_TAG" >> $GITHUB_OUTPUT
            echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
            echo "æœ¬åœ°æœ€æ–°release: $LOCAL_TAG (åŸºç¡€ç‰ˆæœ¬: $BASE_VERSION)"
          else
            echo "local_tag=" >> $GITHUB_OUTPUT
            echo "base_version=" >> $GITHUB_OUTPUT
            echo "æœ¬åœ°æš‚æ— release"
          fi

      - name: Compare versions and determine release type
        id: compare_versions
        if: steps.upstream_release.outputs.upstream_tag != '' && steps.local_release.outputs.base_version != ''
        shell: bash
        run: |
          set -euo pipefail
          UPSTREAM_TAG="${{ steps.upstream_release.outputs.upstream_tag }}"
          BASE_VERSION="${{ steps.local_release.outputs.base_version }}"

          echo "æ¯”è¾ƒç‰ˆæœ¬: upstream=$UPSTREAM_TAG vs local_base=$BASE_VERSION"

          if [ "$UPSTREAM_TAG" = "$BASE_VERSION" ]; then
            echo "needs_release=false" >> $GITHUB_OUTPUT
            echo "ç‰ˆæœ¬ç›¸åŒï¼Œæ— éœ€å‘å¸ƒæ–°release"
            exit 0
          fi

          echo "needs_release=true" >> $GITHUB_OUTPUT

          # è§£æç‰ˆæœ¬å·ç¡®å®šreleaseç±»å‹
          RELEASE_TYPE="patch"
          if [[ "$UPSTREAM_TAG" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            UP_MAJOR=${BASH_REMATCH[1]}
            UP_MINOR=${BASH_REMATCH[2]}
            UP_PATCH=${BASH_REMATCH[3]}

            if [[ "$BASE_VERSION" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
              LOCAL_MAJOR=${BASH_REMATCH[1]}
              LOCAL_MINOR=${BASH_REMATCH[2]}
              LOCAL_PATCH=${BASH_REMATCH[3]}

              if [ "$UP_MAJOR" -gt "$LOCAL_MAJOR" ]; then
                RELEASE_TYPE="major"
              elif [ "$UP_MINOR" -gt "$LOCAL_MINOR" ]; then
                RELEASE_TYPE="minor"
              elif [ "$UP_PATCH" -gt "$LOCAL_PATCH" ]; then
                RELEASE_TYPE="patch"
              fi
            else
              RELEASE_TYPE="major"
            fi
          fi

          echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼Œç±»å‹: $RELEASE_TYPE"

      - name: Trigger release workflow
        if: steps.compare_versions.outputs.needs_release == 'true'
        shell: bash
        run: |
          set -euo pipefail
          RELEASE_TYPE="${{ steps.compare_versions.outputs.release_type }}"
          UPSTREAM_TAG="${{ steps.upstream_release.outputs.upstream_tag }}"

          echo "è§¦å‘releaseå·¥ä½œæµ: type=$RELEASE_TYPE, upstream_version=$UPSTREAM_TAG"

          gh workflow run release.yaml --ref main -f release_type="$RELEASE_TYPE"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Handle first release
        if: steps.upstream_release.outputs.upstream_tag != '' && steps.local_release.outputs.local_tag == ''
        shell: bash
        run: |
          set -euo pipefail
          UPSTREAM_TAG="${{ steps.upstream_release.outputs.upstream_tag }}"
          echo "é¦–æ¬¡å‘ç°upstream releaseï¼Œè§¦å‘major release"

          gh workflow run release.yaml --ref main -f release_type="major"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
